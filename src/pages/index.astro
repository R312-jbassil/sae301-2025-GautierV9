---
import Layout from "../layouts/Layout.astro";
import Header from "../components/header.astro";
import Footer from "../components/footer.astro";
---

<Layout title="Inscription">
  <Header />

  <!-- Onglets Connexion/Inscription -->
  <div class="max-w-7xl mx-auto px-6 pt-12 mb-8">
    <div class="flex w-full gap-1 bg-[#E5E5E5]/80 rounded-xl p-1 shadow-sm">
      <a href="/login"
        class="flex-1 text-center py-3 rounded-xl font-semibold text-lg text-[#B0B0B0] hover:bg-white hover:text-[#1E2A4A]">
        Connexion
      </a>
      <a href="/"
        class="flex-1 text-center py-3 rounded-xl font-semibold text-lg bg-white text-[#1E2A4A] shadow pointer-events-none"
        aria-current="page">
        Inscription
      </a>
    </div>
  </div>

  <!-- Section principale -->
  <section class="max-w-7xl mx-auto px-6 py-12 grid lg:grid-cols-2 gap-12 items-start">
    <div>
      <p class="uppercase tracking-wide text-[#B84651] font-semibold mb-2">Bienvenue</p>
      <h1 class="text-5xl font-extrabold mb-8 text-[#1E2A4A]">Créer un compte</h1>
      <form id="register-form" class="flex flex-col gap-4 bg-white border border-[#E5E5E5] p-8 shadow rounded-lg" autocomplete="off">
        <label for="prenom" class="text-sm mb-1 text-[#B0B0B0]">Votre prénom</label>
        <input name="prenom" id="prenom"
          class="input input-bordered w-full bg-[#F9F9F9] border border-[#E5E5E5] rounded-lg px-4 py-3 text-[#0A0A0A] placeholder:opacity-70 focus:border-[#1E2A4A] focus:ring-0"
          placeholder="Prénom" required />

        <label for="nom" class="text-sm mb-1 text-[#B0B0B0]">Votre nom de famille</label>
        <input name="nom" id="nom"
          class="input input-bordered w-full bg-[#F9F9F9] border border-[#E5E5E5] rounded-lg px-4 py-3 text-[#0A0A0A] placeholder:opacity-70 focus:border-[#1E2A4A] focus:ring-0"
          placeholder="Nom" required />

        <label for="email" class="text-sm mb-1 text-[#B0B0B0]">Votre adresse email (format : exemple@domaine.fr)</label>
        <input name="email" id="email" type="email"
          class="input input-bordered w-full bg-[#F9F9F9] border border-[#E5E5E5] rounded-lg px-4 py-3 text-[#0A0A0A] placeholder:opacity-70 focus:border-[#1E2A4A] focus:ring-0"
          placeholder="Votre email" required />

        <label for="motdepasse" class="text-sm mb-1 text-[#B0B0B0]">Votre mot de passe (min:8 caractères)</label>
        <input name="motdepasse" id="motdepasse" type="password"
          class="input input-bordered w-full bg-[#F9F9F9] border border-[#E5E5E5] rounded-lg px-4 py-3 text-[#0A0A0A] placeholder:opacity-70 focus:border-[#1E2A4A] focus:ring-0"
          placeholder="Mot de passe" required />

        <button type="submit"
          class="btn w-full mt-2 bg-[#1E2A4A] text-white font-semibold py-3 rounded-lg shadow hover:bg-[#162038] transition duration-150">
          S'inscrire
        </button>
      </form>
      <div id="register-result" class="mt-4 text-sm text-[#B84651]"></div>
    </div>
  </section>
  <Footer />

  <!-- Pop-up succès -->
  <div id="success-modal"
  style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(20,20,20,0.7); align-items:center; justify-content:center;">
  <div
    style="background:white; padding:4rem 6rem; border-radius:1.5rem; box-shadow:0 2px 32px rgba(0,0,0,0.2); text-align:center; width:75vw; max-width:920px; min-width:320px; margin:auto;">
    <h2 style="font-size:2.5rem; margin-bottom:1.5rem;">Inscription réussie !</h2>
    <p style="margin-bottom:2.5rem; font-size:1.35rem;">Votre compte a bien été créé.</p>
    <button id="go-configurator"
      style="background:#1E2A4A; color:white; font-weight:bold; padding:1rem 2.5rem; border:none; border-radius:0.8rem; font-size:1.25rem; cursor:pointer;">
      Continuer vers le configurateur
    </button>
  </div>
</div>

  <script>
    const form = document.getElementById('register-form');
    const modal = document.getElementById('success-modal');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prenom = document.getElementById('prenom').value.trim();
      const nom = document.getElementById('nom').value.trim();
      const email = document.getElementById('email').value.trim();
      const motdepasse = document.getElementById('motdepasse').value;

      const pocketbaseUrl = 'http://127.0.0.1:8090/api/collections/users/records';
      const data = {
        email: email,
        password: motdepasse,
        passwordConfirm: motdepasse,
        name: prenom + ' ' + nom
      };

      try {
        const response = await fetch(pocketbaseUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
          form.reset();
          modal.style.display = "flex"; // Affiche le pop-up seulement après succès
        } else {
          document.getElementById('register-result').textContent = result.message ? result.message : "Erreur pendant l'inscription";
          console.log(result);
        }
      } catch (err) {
        document.getElementById('register-result').textContent = "Erreur serveur ou connexion PocketBase";
        console.log(err);
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'go-configurator') {
        window.location.href = "/configurateur";
      }
    });
  </script>
</Layout>